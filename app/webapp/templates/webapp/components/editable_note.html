{% load static %}
{% load dj_htmx %}
{% load custom_filters %}
{% load humanize %}


{# Slack-style vessel note messages component #}
<div class="note-messages-component">
  <!-- Add Message Button and Form (JS swap) -->
  <div id="add-message-form-container">
    <button id="add-message-btn"
            class="btn btn-primary mb-2"
            onclick="showAddMessageForm()">
      Add Message
    </button>
  </div>

  <!-- Messages Scroll -->
  <div class="messages-scroll" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; padding: 1rem; background: #fafbfc;">
    {% for message in note.messages.all %}
      <div id="vessel-note-message-{{ message.id }}" class="message-item mb-3 p-2" style="border-bottom: 1px solid #e0e0e0; margin-bottom: 1rem; padding: 0.5rem;">
        <div style="display: flex; align-items: center; margin-bottom: 0.25rem;">
          <span class="{% if message.user == request.user %}username-current-user{% else %}username-other-user{% endif %}" style="font-weight: bold; margin-right: 0.5rem;">{{ message.user.username }}</span>
          <span style="color: #888; font-size: 0.9em;" title="{{ message.created_at|date:'c' }}">
            {{ message.created_at|naturaltime }}
          </span>
        </div>
        <div class="message-body" id="message-body-{{ message.id }}"
             data-raw="{{ message.content|safe }}"
        >
          {% if message.content|length > 500 %}
            <span class="truncated">{{ message.content|slice:":500" }}&hellip;</span>
            <a href="#" class="expand-link" data-message-id="{{ message.id }}" onclick="expandMessage({{ message.id }}); return false;">Expand ▼</a>
            <span class="full-content" style="display: none;">{{ message.content|linebreaksbr }}</span>
            <a href="#" class="collapse-link" data-message-id="{{ message.id }}" style="display: none;" onclick="collapseMessage({{ message.id }}); return false;">Collapse ▲</a>
          {% else %}
            <span class="rendered-markdown"></span>
          {% endif %}
        </div>
        <div style="margin-top: 0.25rem;">
          <button class="note-action-btn" style="background: none; border: none; color: #007bff; font-size: 0.95em; margin-right: 0.5rem; cursor: pointer; padding: 0;"
                  data-message-id="{{ message.id }}"
                  onclick="showAddMessageForm(generateReplyPrefill(this.getAttribute('data-message-id'))); return false;">
            <span class="action-label">Reply</span>
          </button>
          {% if message.user == request.user %}
            <button class="note-action-btn" style="background: none; border: none; color: #007bff; font-size: 0.95em; cursor: pointer; padding: 0;" onclick="startInlineEdit({{ message.id }})"><span class="action-label">Edit</span></button>
          {% endif %}
        </div>
      </div>
    {% empty %}
      <div class="text-muted">No messages yet.</div>
    {% endfor %}
  </div>
</div>

<script>
function expandMessage(id) {
  const msg = document.getElementById('message-body-' + id);
  msg.querySelector('.truncated').style.display = 'none';
  msg.querySelector('.expand-link').style.display = 'none';
  msg.querySelector('.full-content').style.display = '';
  msg.querySelector('.collapse-link').style.display = '';
}
function collapseMessage(id) {
  const msg = document.getElementById('message-body-' + id);
  msg.querySelector('.truncated').style.display = '';
  msg.querySelector('.expand-link').style.display = '';
  msg.querySelector('.full-content').style.display = 'none';
  msg.querySelector('.collapse-link').style.display = 'none';
}

// Markdown rendering for messages
function renderAllMarkdownMessages() {
  document.querySelectorAll('.message-body').forEach(function(el) {
    // Only render if not in edit mode and not a truncated message
    if (el.querySelector('.truncated')) return;
    const raw = el.getAttribute('data-raw');
    if (raw !== null) {
      const rendered = marked.parse(raw);
      const target = el.querySelector('.rendered-markdown');
      if (target) target.innerHTML = rendered;
    }
  });
}

document.addEventListener('DOMContentLoaded', renderAllMarkdownMessages);
document.body.addEventListener('htmx:afterSwap', function(evt) {
  renderAllMarkdownMessages();
});

function startInlineEdit(id) {
  const msgDiv = document.getElementById('message-body-' + id);
  const raw = msgDiv.getAttribute('data-raw');
  // Save original HTML to restore on cancel
  msgDiv.dataset.originalHtml = msgDiv.innerHTML;
  // Add editing class to parent message item
  const msgItem = document.getElementById(`vessel-note-message-${id}`);
  if (msgItem) msgItem.classList.add('editing');
  // Add editing-active to the main container
  const mainContainer = document.querySelector('.note-messages-component');
  if (mainContainer) mainContainer.classList.add('editing-active');
  msgDiv.innerHTML = `
    <textarea id="edit-input-${id}" class="form-control" style="width: 100%; min-height: 5em; resize: vertical; margin-bottom: 0.5em;" rows="4">${raw.replace(/&quot;/g, '"').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>')}</textarea>
    <div class="edit-controls">
      <button onclick="saveInlineEdit(${id})" class="note-action-btn" style="margin-right: 0.5em;">Save</button>
      <button onclick="cancelInlineEdit(${id})" class="note-action-btn">Cancel</button>
    </div>
  `;
  document.getElementById(`edit-input-${id}`).focus();
}

function cancelInlineEdit(id) {
  const msgDiv = document.getElementById('message-body-' + id);
  if (msgDiv.dataset.originalHtml) {
    msgDiv.innerHTML = msgDiv.dataset.originalHtml;
    delete msgDiv.dataset.originalHtml;
    // Remove editing class from parent message item
    const msgItem = document.getElementById(`vessel-note-message-${id}`);
    if (msgItem) msgItem.classList.remove('editing');
    // Remove editing-active from the main container
    const mainContainer = document.querySelector('.note-messages-component');
    if (mainContainer) mainContainer.classList.remove('editing-active');
  }
}

function saveInlineEdit(id) {
  const msgDiv = document.getElementById('message-body-' + id);
  const input = document.getElementById(`edit-input-${id}`);
  let newValue = input.value.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  newValue = newValue.replace(/>/g, '&gt;');
  // Use HTMX to POST the new value and swap the message
  const formData = new FormData();
  formData.append('content', newValue);
  fetch(`/vessels/note/message/${id}/update/`, {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'HX-Request': 'true',
      'X-CSRFToken': getCookie('csrftoken'),
    },
    body: formData
  })
  .then(response => response.text())
  .then(html => {
    // Replace the whole message item
    const msgItem = document.getElementById(`vessel-note-message-${id}`);
    if (msgItem) {
      msgItem.outerHTML = html;
    }
    // Re-render markdown if needed
    renderAllMarkdownMessages();
  });
}

// Helper to get CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function showAddMessageForm(prefill = '') {
  const container = document.getElementById('add-message-form-container');
  container.innerHTML = `
    <form id="add-message-form" onsubmit="submitAddMessage(event)">
      <textarea id="add-message-content" class="form-control" style="width: 100%; min-height: 4em; resize: vertical; margin-bottom: 0.5em;" rows="4" placeholder="Write a message...">${prefill}</textarea>
      <div>
        <button type="submit" class="note-action-btn" style="margin-right: 0.5em;">Send</button>
        <button type="button" class="note-action-btn" onclick="cancelAddMessageForm()">Cancel</button>
      </div>
    </form>
  `;
  document.getElementById('add-message-content').focus();
}

function cancelAddMessageForm() {
  const container = document.getElementById('add-message-form-container');
  container.innerHTML = `
    <button id="add-message-btn"
            class="btn btn-primary mb-2"
            onclick="showAddMessageForm()">
      Add Message
    </button>
  `;
}

function submitAddMessage(event) {
  event.preventDefault();
  const textarea = document.getElementById('add-message-content');
  let content = textarea.value.replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
  content = content.replace(/>/g, '&gt;');
  if (!content) return;
  const noteId = {{ note.id }};
  fetch(`/vessels/note/${noteId}/message/add/`, {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRFToken': getCookie('csrftoken'),
    },
    body: new URLSearchParams({ content })
  })
  .then(response => response.text())
  .then(html => {
    // Insert new message at the end
    const scroll = document.querySelector('.messages-scroll');
    scroll.insertAdjacentHTML('beforeend', html);
    cancelAddMessageForm();
    renderAllMarkdownMessages();
  });
}

function generateReplyPrefill(messageId) {
  const msgDiv = document.getElementById('message-body-' + messageId);
  const raw = msgDiv ? (msgDiv.getAttribute('data-raw') || '') : '';
  let quote = raw.slice(0, 100);
  if (raw.length > 100) quote += '...';
  // Escape > in quote
  quote = quote.replace(/^/gm, '> ');
  return `[View original message](#vessel-note-message-${messageId})\n\n${quote}\n\n\n`;
}

</script>

<style>
.form-control:focus {
  outline: none;
  box-shadow: none;
  border-color: #ccc;
}

/* Hide action buttons when editing */
.message-item.editing .note-action-btn:not(.edit-controls .note-action-btn) {
  display: none;
}

/* Shared style for all note action buttons */
.note-action-btn {
  background: none;
  border: none;
  color: #007bff;
  font-size: 0.95em;
  cursor: pointer;
  padding: 0.2em 0.7em;
  border-radius: 4px;
  transition: background 0.15s, color 0.15s;
  margin-right: 0.5em;
}
.note-action-btn:last-child {
  margin-right: 0;
}
.note-action-btn:hover, .note-action-btn:focus {
  background: #e6f0ff;
  color: #0056b3;
  outline: none;
}

.note-messages-component.editing-active #add-message-btn {
  display: none;
}

@media (max-width: 600px) {
  .messages-scroll {
    width: 100vw !important;
    left: 50%;
    right: 0;
    margin-left: -50vw;
    border-radius: 0 !important;
    max-width: 100vw !important;
    position: relative;
    box-sizing: border-box;
  }
}

/* Username color coding */
.username-current-user {
  color: #0056b3; /* Project dark blue */
}
.username-other-user {
  color: #00bcd4; /* Project aqua */
}
</style>
